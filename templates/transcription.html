{% extends "base.html" %}

{% block content %}
    <div class="page-container">
        <div class="card">
            <div class="card-left">
                <div class="logo-circle">ATW</div>
                <h1 class="app-title">AutoTube Writer</h1>
                <p class="app-subtitle">
                    Collez une URL YouTube et obtenez instantan√©ment un article de qualit√© pr√™t √† √™tre r√©f√©renc√©.
                </p>

                <ul class="feature-list">
                    <li>üéß Support des vid√©os longues et courtes</li>
                    <li>üåç Transcriptions multilingues (FR / EN selon dispo)</li>
                    <li>üìÑ Copiez ou sauvegardez le texte facilement</li>
                </ul>

                {% if transcript %}
                  <div class="badge badge-success">
                    ‚úÖ Transcription pr√™te pour la vid√©o : <span>{{ video_id }}</span>
                  </div>
                {% elif erreur %}
                  <div class="badge badge-warning">
                    ‚ö†Ô∏è Une erreur est survenue, v√©rifiez l‚ÄôURL et r√©essayez.
                  </div>
                {% else %}
                  <div class="badge badge-neutral">
                     Commencez par coller une URL de vid√©o YouTube ci-contre.
                  </div>
                {% endif %}
            </div>

            <div class="card-right">
                <h2 class="form-title">Transcrire une vid√©o</h2>
                <p class="form-subtitle">
                    Collez simplement l‚ÄôURL compl√®te de la vid√©o YouTube ci-dessous.
                </p>

                <form method="POST" class="form" id="form-transcription">
                    <label for="url" class="form-label">URL de la vid√©o YouTube</label>
                    <div class="input-group">
                        <span class="input-prefix">https://</span>
                        <input
                            type="text"
                            id="url"
                            name="url"
                            class="input-text"
                            placeholder="www.youtube.com/watch?v=..."
                            value="{{ url or '' }}"
                            required
                        >
                    </div>

                    {% if erreur %}
                      <div class="alert alert-error">
                          {{ erreur }}
                      </div>
                    {% endif %}

                    <button type="submit" class="btn-primary">
                        R√©cup√©rer la transcription
                    </button>

                    <p class="helper-text">
                        En collant un lien, vous acceptez que le texte affich√© provienne des
                        sous-titres disponibles sur YouTube (qu‚Äôils soient automatiques ou non).
                    </p>
                </form>

                <div id="transcription-skeleton" class="skeleton-card hidden">
                    <div class="skeleton-header">
                        <div class="skeleton-title"></div>
                            <div class="skeleton-chip"></div>
                    </div>
                    <div class="skeleton-lines">
                        <div class="skeleton-line"></div>
                            <div class="skeleton-line"></div>
                            <div class="skeleton-line short"></div>
                    </div>
                </div>

                {% if transcript %}
                  <div class="transcript-container">
                      <div class="transcript-header">
                          <h3>Transcription</h3>
                          <button type="button" class="btn-secondary" onclick="copierTranscription()">
                              Copier le texte
                          </button>
                      </div>
                      <textarea id="transcript-text" readonly>{{ transcript }}</textarea>

                      <h3>G√©n√©ration de l'article</h3>

                        <!-- Nouveau : formulaire pour g√©n√©rer un article de blog -->
                    <form method="POST" action="{{ url_for('blogify') }}" class="form" id="form-blogify" style="margin-top: 14px;">
                    <label for="titre_souhaite" class="form-label">Titre souhait√© pour l'article (optionnel)</label>
                        <input
                            type="text"
                            id="titre_souhaite"
                            name="titre_souhaite"
                            class="input-text"
                            placeholder="Ex : Comment la transcription YouTube peut booster votre contenu ?"
                        >

                    <!-- On renvoie le texte source dans un champ cach√© -->
                    <textarea name="source_text" hidden>{{ transcript }}</textarea>

                    <!-- Option : g√©n√©rer une image (2 cr√©dits en plus) -->
                    <div class="form-checkbox-row" style="margin-top: 10px; margin-bottom: 10px;">
                        <label style="display:flex; align-items:center; gap:8px; font-size:14px;">
                            <input type="checkbox" name="with_image" value="1">
                            <span>G√©n√©rer aussi une image pour illustrer l‚Äôarticle (2 cr√©dits)</span>
                        </label>
                    </div>

                    <button id="btn-generate" type="submit" class="btn-primary">
                    G√©n√©rer un article de blog optimis√© (1 cr√©dit)
                    </button>
                    </form>
                  </div>
                {% endif %}
                
            </div>

            <div id="article-skeleton" class="article-card full-width-section hidden">
                <div class="article-card-inner">

                     <!-- Barre de progression de g√©n√©ration d'article -->
            <div id="article-progress" class="progress-wrapper">
                <div class="progress-label">
                Cr√©ation de l'article en cours‚Ä¶
                </div>
                <div class="progress-bar-bg">
                    <div class="progress-bar-fill"></div>
                </div>
            </div>



                    <div class="article-card-header">
                    <div class="skeleton-title wide"></div>
                </div>

                <div class="seo-meta">
                    <div class="skeleton-line short"></div>
                    <div class="skeleton-line short"></div>
                    <div class="skeleton-line shorter"></div>
                </div>

                <div class="article-image-wrapper">
                    <div class="skeleton-image"></div>
                </div>

                <div class="article-content">
                    <div class="skeleton-line"></div>
                    <div class="skeleton-line"></div>
                    <div class="skeleton-line"></div>
                    <div class="skeleton-line short"></div>
                </div>
            </div>
        </div>


             {% if article_html %}
        <div class="article-card full-width-section">
            <div class="article-card-inner">
                <div class="article-card-header">
                <div>
                  <h2>Article de blog g√©n√©r√©</h2>
                  <p>Contenu HTML pr√™t √† √™tre copi√©-coll√© dans ton CMS.</p>
              </div>

              <div class="article-header-actions">
                  <button type="button" class="btn-secondary" onclick="copierArticleHTML()">
                      Copier l‚Äôarticle
                  </button>
                  <button type="button" class="btn-secondary" onclick="ouvrirArticleNouvelOnglet()">
                      Voir dans un nouvel onglet
                  </button>
              </div>
          </div>

          <!-- Bloc SEO -->
          <div class="seo-meta">
              {% if seo_keyword %}
                <div class="seo-item">
                    <span class="seo-label">Mot-cl√© principal :</span>
                    <span class="seo-value">{{ seo_keyword }}</span>
                </div>
              {% endif %}

              {% if seo_title %}
                <div class="seo-item">
                    <span class="seo-label">Title SEO :</span>
                    <span class="seo-value">{{ seo_title }}</span>
                </div>
              {% endif %}

              {% if meta_description %}
                <div class="seo-item">
                    <span class="seo-label">Meta description :</span>
                    <span class="seo-value">{{ meta_description }}</span>
                </div>
              {% endif %}
          </div>

          {% if image_url %}
            <div class="article-image-wrapper">
                <img src="{{ image_url }}" alt="Image g√©n√©r√©e pour illustrer l‚Äôarticle"
                class="article-image">

                <div class="article-image-actions">
                    <a href="{{ image_url }}"
                    download="illustration-article.png"
                    class="btn-secondary btn-download-image">
                    T√©l√©charger l‚Äôimage
                    </a>
                </div>
            </div>
          {% endif %}
            

          <!-- Contenu de l'article -->
          <div id="article-html" class="article-content">
              {{ article_html|safe }} <!-- Pour que Flask rende le HTML, pas du texte brut -->
          </div>
      </div>
  </div>
{% endif %}    

        </div>

        <button id="btn-back-to-top" class="back-to-top hidden" title="Retour en haut">
            ‚¨Ü
        </button>

    {% endblock %}

    {% block scripts %}
    <script>
        function copierTranscription() {
            const textarea = document.getElementById('transcript-text');
            if (!textarea) return;

            textarea.select();
            textarea.setSelectionRange(0, 99999); // pour mobile

            try {
                document.execCommand('copy');
                alert('Transcription copi√©e dans le presse-papier ‚úîÔ∏è');
            } catch (e) {
                alert('Impossible de copier automatiquement. S√©lectionnez le texte manuellement.');
            }
        }

        function copierArticleHTML() {
            const articleEl = document.getElementById("article-html");
            if (!articleEl) {
            alert("Erreur : article introuvable.");
            return;
        }

        // Cr√©ation d‚Äôun √©l√©ment temporaire pour copier l‚ÄôHTML
            const temp = document.createElement("textarea");
            temp.value = articleEl.innerHTML.trim();
            document.body.appendChild(temp);

            temp.select();
            temp.setSelectionRange(0, 999999); // Compatibilit√© mobile

        try {
            document.execCommand("copy");
            alert("Article copi√© dans le presse-papier ‚úîÔ∏è");
        } catch (err) {
            alert("Impossible de copier automatiquement. Copiez manuellement.");
        }

        document.body.removeChild(temp);
        }


    function ouvrirArticleNouvelOnglet() {
    const articleEl = document.getElementById("article-html");
    if (!articleEl) {
        alert("Erreur : article introuvable.");
        return;
    }

    const htmlContent = articleEl.innerHTML;

    const win = window.open("", "_blank");
    if (!win) {
        alert("Le navigateur a bloqu√© l‚Äôouverture du nouvel onglet.");
        return;
    }

    win.document.write(`<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <title>Aper√ßu de l‚Äôarticle</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 800px;
      margin: 30px auto;
      padding: 0 16px 40px;
      line-height: 1.7;
    }
    h1, h2, h3 {
      margin-top: 1.4em;
      margin-bottom: 0.4em;
    }
    p {
      margin: 0.4em 0 0.8em;
    }
    ul, ol {
      padding-left: 1.4rem;
      margin: 0.4em 0 0.8em;
    }
    li {
      margin-bottom: 0.2em;
    }
    blockquote {
      margin: 0.8em 0;
      padding-left: 1em;
      border-left: 3px solid #e5e7eb;
      font-style: italic;
      color: #6b7280;
    }
  </style>
</head>
<body>
${htmlContent}
</body>
</html>`);
    win.document.close();
}
document.addEventListener("DOMContentLoaded", function () {
    const formTranscription = document.getElementById("form-transcription");
    const formBlogify = document.getElementById("form-blogify");
    const skeletonTranscription = document.getElementById("transcription-skeleton");
    const skeletonArticle = document.getElementById("article-skeleton");
    const articleProgress = document.getElementById("article-progress");

    if (formTranscription) {
        formTranscription.addEventListener("submit", function () {
            // Affiche le skeleton de transcription
            if (skeletonTranscription) {
                skeletonTranscription.classList.remove("hidden");
            }
            // Bouton en √©tat loading
            const btn = formTranscription.querySelector("button[type='submit']");
            if (btn) {
                btn.classList.add("btn-loading");
                btn.setAttribute("disabled", "disabled");
            }
        });
    }

    if (formBlogify) {
        formBlogify.addEventListener("submit", function () {
            // Affiche la card skeleton pour l'article
            if (skeletonArticle) {
                skeletonArticle.classList.remove("hidden");
            }
            if (articleProgress) {
                articleProgress.classList.remove("hidden");
            }
            const btn = formBlogify.querySelector("button[type='submit']");
            if (btn) {
                btn.classList.add("btn-loading");
                btn.setAttribute("disabled", "disabled");
            }
        });
    }
});

document.addEventListener("DOMContentLoaded", function () {
    
    // üåü Bouton retour en haut
    const btnTop = document.getElementById("btn-back-to-top");

    if (btnTop) {
        // Apparition du bouton si on scroll un peu
        window.addEventListener("scroll", function () {
            if (window.scrollY > 300) {
                btnTop.classList.add("show");
                btnTop.classList.remove("hidden");
            } else {
                btnTop.classList.remove("show");
            }
        });

        // Scroll vers le haut au clic
        btnTop.addEventListener("click", function () {
            window.scrollTo({
                top: 0,
                behavior: "smooth"
            });
        });
    }
});

document.getElementById('form-blogify').addEventListener('submit', function(e){
  const btn = document.getElementById('btn-generate');
  btn.disabled = true;
  btn.textContent = "G√©n√©ration en cours‚Ä¶";
});
</script>

{% endblock %}
